# 🔄 域名切换详细步骤

## 📋 你的情况
- 原域名已经连接了很多服务，需要换回去
- 在 Cloudflare 新买了一个域名
- 需要用新域名连接 Vercel 项目

---

## 🎯 操作步骤

### 第一步：恢复原域名配置

#### 1.1 在 Vercel 移除原域名

1. 登录 Vercel Dashboard：https://vercel.com
2. 进入你的项目（xyvn-website）
3. 点击 **Settings** → **Domains**
4. 找到原域名（例如 `www.xyvnai.com`）
5. 点击域名旁边的 **"..."** → **Remove**
6. 确认删除

#### 1.2 在 Cloudflare 恢复原域名的 DNS 配置

1. 登录 Cloudflare Dashboard：https://dash.cloudflare.com
2. 选择原域名
3. 进入 **DNS** → **Records**
4. 找到之前修改的记录（指向 Vercel 的 CNAME 或 A 记录）
5. 删除或修改回原来的配置

**如果原来是 Cloudflare Pages：**
```
类型: CNAME
名称: www
目标: [你的项目名].pages.dev
代理状态: 已代理（橙色云朵）
```

**如果原来是其他服务：**
- 恢复原来的 DNS 记录
- 如果不记得了，可以查看 Cloudflare 的 DNS 历史记录

#### 1.3 等待 DNS 生效

- 通常需要 5-10 分钟
- 访问原域名，确认已恢复正常

---

### 第二步：配置新域名到 Vercel

假设你的新域名是 `newdomain.com`

#### 2.1 在 Vercel 添加新域名

1. 在 Vercel Dashboard 中，进入你的项目
2. 点击 **Settings** → **Domains**
3. 在输入框中输入新域名：
   - 输入 `newdomain.com`（根域名）
   - 点击 **Add**
4. 再添加 www 子域名：
   - 输入 `www.newdomain.com`
   - 点击 **Add**

5. **记录 Vercel 显示的 DNS 配置信息**

Vercel 会显示类似这样的信息：

**对于根域名 `newdomain.com`：**
```
类型: A
名称: @
值: 76.76.21.21
```

**对于 www 子域名 `www.newdomain.com`：**
```
类型: CNAME
名称: www
值: cname.vercel-dns.com
```

#### 2.2 在 Cloudflare 配置新域名的 DNS

1. 登录 Cloudflare Dashboard：https://dash.cloudflare.com
2. 选择你的新域名
3. 进入 **DNS** → **Records**

4. **添加根域名记录：**
   - 点击 **Add record**
   - Type: `A`
   - Name: `@`
   - IPv4 address: `76.76.21.21`
   - Proxy status: **🟠 DNS only**（灰色云朵，关闭代理）
   - TTL: `Auto`
   - 点击 **Save**

5. **添加 www 子域名记录：**
   - 点击 **Add record**
   - Type: `CNAME`
   - Name: `www`
   - Target: `cname.vercel-dns.com`
   - Proxy status: **🟠 DNS only**（灰色云朵，关闭代理）
   - TTL: `Auto`
   - 点击 **Save**

⚠️ **重要提示：**
- 必须选择 **DNS only**（灰色云朵）
- 不要使用 Cloudflare 代理（橙色云朵）
- 否则 Vercel 无法验证域名和配置 SSL 证书

#### 2.3 等待 DNS 传播和验证

1. **等待时间：** 5-30 分钟（最长 48 小时）

2. **检查 DNS 传播：**
   - 访问：https://dnschecker.org
   - 输入你的新域名
   - 查看全球解析状态

3. **在 Vercel 检查状态：**
   - 回到 Vercel → Settings → Domains
   - 等待域名状态变为 **"Valid"**
   - 如果显示错误，点击 **Refresh** 按钮

4. **SSL 证书自动配置：**
   - Vercel 会自动申请 Let's Encrypt SSL 证书
   - 通常在域名验证后 1-5 分钟完成
   - 状态显示为 "Valid" 并带有绿色锁图标

#### 2.4 设置主域名（可选）

如果你想让 www 自动跳转到根域名（或反之）：

1. 在 Vercel → Settings → Domains
2. 找到你想设为主域名的那个
3. 点击 **"..."** → **Set as Primary**
4. 其他域名会自动重定向到主域名

推荐设置：
- 主域名：`newdomain.com`
- 自动重定向：`www.newdomain.com` → `newdomain.com`

---

### 第三步：更新项目配置

#### 3.1 更新 Vercel 环境变量

1. 在 Vercel → Settings → Environment Variables
2. 找到 `NEXTAUTH_URL`
3. 点击 **Edit**
4. 修改为新域名：
   ```
   NEXTAUTH_URL=https://newdomain.com
   ```
   或
   ```
   NEXTAUTH_URL=https://www.newdomain.com
   ```
5. 选择应用到：**Production, Preview, Development**
6. 点击 **Save**

#### 3.2 更新本地 .env.local 文件

```bash
# 修改 .env.local
NEXTAUTH_URL=https://newdomain.com
```

#### 3.3 更新代码中的域名引用（如果有）

检查以下文件，更新硬编码的域名：

1. **src/app/layout.tsx** - metadata 配置
2. **src/app/sitemap.ts** - sitemap 生成
3. **src/app/robots.txt** - robots 配置
4. **任何 API 调用或外部链接**

#### 3.4 重新部署

1. 提交代码更改（如果有）：
   ```bash
   git add .
   git commit -m "更新域名配置"
   git push
   ```

2. 或在 Vercel Dashboard 手动触发部署：
   - Deployments → 最新部署 → **"..."** → **Redeploy**

---

### 第四步：验证配置

#### 4.1 测试新域名访问

1. 访问：`https://newdomain.com`
2. 访问：`https://www.newdomain.com`
3. 检查是否能正常访问网站
4. 检查 HTTPS 是否正常（绿色锁图标）

#### 4.2 测试管理后台

1. 访问：`https://newdomain.com/admin/login`
2. 尝试登录
3. 测试所有管理功能：
   - 创建/编辑文章
   - 上传图片
   - 管理分类和标签

#### 4.3 测试 API 功能

1. 检查前台文章列表
2. 检查文章详情页
3. 检查联系表单提交
4. 检查所有 API 端点

---

### 第五步：启用 Cloudflare 代理（可选）

⚠️ **只有在 Vercel 完全配置成功后才能启用！**

#### 5.1 确认 Vercel 配置完成

- ✅ SSL 证书已颁发
- ✅ 域名状态为 "Valid"
- ✅ 网站可以正常访问
- ✅ 所有功能正常工作

#### 5.2 启用 Cloudflare 代理

1. 回到 Cloudflare → DNS → Records
2. 找到你的 DNS 记录
3. 点击灰色云朵，变成橙色云朵
4. 保存更改

#### 5.3 配置 Cloudflare SSL

1. 进入 **SSL/TLS** → **Overview**
2. 加密模式选择：**Full (strict)**
3. 进入 **Edge Certificates**
4. 开启以下选项：
   - ✅ Always Use HTTPS
   - ✅ Automatic HTTPS Rewrites
   - ✅ Opportunistic Encryption

---

## 🔍 故障排查

### 问题 1：域名验证失败

**可能原因：**
- DNS 记录配置错误
- Cloudflare 代理未关闭
- DNS 还未传播

**解决方案：**
1. 检查 DNS 记录是否完全正确
2. 确认 Cloudflare 代理已关闭（灰色云朵）
3. 等待 10-30 分钟后重试
4. 使用命令检查 DNS：
   ```bash
   # macOS/Linux
   dig newdomain.com
   dig www.newdomain.com
   
   # 或
   nslookup newdomain.com
   nslookup www.newdomain.com
   ```

### 问题 2：SSL 证书无法颁发

**解决方案：**
1. 确认域名已验证成功
2. 关闭 Cloudflare 代理
3. 在 Vercel 删除域名后重新添加
4. 等待 5-10 分钟

### 问题 3：网站显示 404 或错误

**解决方案：**
1. 检查 Vercel 项目是否已部署
2. 检查环境变量是否正确
3. 查看 Vercel 部署日志
4. 重新部署项目

### 问题 4：登录功能不工作

**可能原因：**
- `NEXTAUTH_URL` 环境变量未更新

**解决方案：**
1. 检查 Vercel 环境变量
2. 确认 `NEXTAUTH_URL` 是新域名
3. 重新部署项目

---

## ✅ 完成检查清单

- [ ] 原域名已从 Vercel 移除
- [ ] 原域名 DNS 已恢复原配置
- [ ] 原域名可以正常访问原服务
- [ ] 新域名已添加到 Vercel
- [ ] 新域名 DNS 已配置（A 和 CNAME 记录）
- [ ] Cloudflare 代理已关闭（灰色云朵）
- [ ] Vercel 域名状态显示 "Valid"
- [ ] SSL 证书已自动配置
- [ ] 新域名可以通过 HTTPS 访问
- [ ] 管理后台可以登录
- [ ] 所有功能正常工作
- [ ] 环境变量已更新
- [ ] 代码中的域名引用已更新（如果有）

---

## 📝 配置示例

假设：
- 原域名：`www.xyvnai.com`
- 新域名：`newdomain.com`

### Cloudflare DNS 配置（新域名）：

| Type  | Name | Content              | Proxy Status | TTL  |
|-------|------|----------------------|--------------|------|
| A     | @    | 76.76.21.21          | DNS only     | Auto |
| CNAME | www  | cname.vercel-dns.com | DNS only     | Auto |

### Vercel Domains 配置：

```
newdomain.com          ✓ Valid (Primary)
www.newdomain.com      ✓ Valid (Redirects to newdomain.com)
```

### Vercel 环境变量：

```
NEXTAUTH_URL=https://newdomain.com
```

---

## 🎉 完成！

按照这些步骤操作后：
- ✅ 原域名恢复正常，继续服务原有业务
- ✅ 新域名成功连接到 Vercel
- ✅ 网站在新域名下正常运行
- ✅ 所有功能正常工作

---

## 💡 额外建议

1. **保留原域名一段时间**
   - 如果有用户或搜索引擎还在使用原域名
   - 可以设置 301 重定向到新域名

2. **更新外部链接**
   - 社交媒体账号
   - 名片和宣传材料
   - 合作伙伴网站

3. **通知用户**
   - 发送邮件通知
   - 在网站上显示公告
   - 更新 Google Search Console

4. **监控流量**
   - 使用 Vercel Analytics
   - 检查是否有异常流量下降
   - 确保 SEO 不受影响

---

需要帮助？随时问我！ 🚀
