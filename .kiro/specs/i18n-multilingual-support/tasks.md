# 实现计划：多语言支持功能

## 概述

本实现计划将 Next.js 网站的多语言支持功能分解为可执行的开发任务。实现将采用渐进式方法，先建立核心基础设施，然后逐步添加功能，最后进行优化和测试。

## 任务

- [x] 1. 安装和配置 i18n 基础设施
  - 安装 next-intl 库和相关依赖
  - 创建 i18n 配置文件（config.ts, routing.ts, request.ts）
  - 设置语言常量和类型定义
  - _需求：1.1, 2.1, 7.1_

- [ ] 2. 创建翻译文件结构
  - [x] 2.1 创建 locales 目录结构
    - 为三种语言（zh-CN, zh-TW, en）创建目录
    - 创建通用翻译文件（common.json）
    - _需求：7.1, 7.5_
  
  - [x] 2.2 编写初始翻译内容
    - 翻译导航菜单项
    - 翻译页脚链接
    - 翻译通用 UI 文本（按钮、标签等）
    - _需求：3.5_
  
  - [ ] 2.3 编写属性测试：翻译字典查找正确性
    - **属性 5：翻译字典查找正确性**
    - **验证需求：3.2, 7.3, 7.5**

- [ ] 3. 实现中间件和路由处理
  - [x] 3.1 更新 middleware.ts
    - 集成 next-intl 中间件
    - 保留现有的管理后台认证逻辑
    - 实现语言检测和重定向
    - 设置语言 cookie
    - _需求：1.1, 2.1, 2.4, 2.5, 8.1_
  
  - [ ] 3.2 编写属性测试：语言检测和默认设置
    - **属性 1：语言检测和默认设置**
    - **验证需求：1.1, 8.3, 8.4**
  
  - [ ] 3.3 编写属性测试：路由和语言对应关系
    - **属性 4：路由和语言对应关系**
    - **验证需求：2.2, 2.5**

- [ ] 4. 创建语言路由布局
  - [-] 4.1 创建 app/[locale] 目录结构
    - 移动现有页面到 [locale] 目录下
    - 创建语言布局组件（layout.tsx）
    - 实现 generateStaticParams 函数
    - 配置元数据生成
    - _需求：2.2, 5.3, 5.4_
  
  - [ ] 4.2 更新根布局
    - 移除语言相关的硬编码
    - 确保管理后台路由不受影响
    - _需求：2.1_
  
  - [ ] 4.3 编写属性测试：SEO 元数据本地化
    - **属性 9：SEO 元数据本地化**
    - **验证需求：5.1, 5.3, 5.4, 5.5**

- [ ] 5. 开发语言切换器组件
  - [x] 5.1 创建 LanguageSwitcher 组件
    - 实现下拉菜单 UI
    - 添加语言图标和名称
    - 实现语言切换逻辑
    - 添加加载状态和错误处理
    - 支持移动端响应式设计
    - _需求：1.2, 1.3, 4.1, 4.2, 4.4, 14.1, 14.3, 14.4_
  
  - [ ] 5.2 编写属性测试：语言切换立即生效
    - **属性 3：语言切换立即生效**
    - **验证需求：1.3, 2.3**
  
  - [ ] 5.3 编写属性测试：语言偏好往返一致性
    - **属性 2：语言偏好往返一致性**
    - **验证需求：1.4, 1.5, 8.1, 8.2, 8.5**
  
  - [ ] 5.4 编写属性测试：语言切换器状态一致性
    - **属性 8：语言切换器状态一致性**
    - **验证需求：4.1, 4.2**
  
  - [ ] 5.5 编写属性测试：语言切换状态控制
    - **属性 17：语言切换状态控制**
    - **验证需求：14.1, 14.3, 14.4**

- [ ] 6. 检查点 - 基础功能验证
  - 确保所有测试通过，验证语言切换基本功能正常工作，如有问题请询问用户

- [ ] 7. 集成语言切换器到导航栏
  - [ ] 7.1 更新 NavbarEnhanced 组件
    - 导入并添加 LanguageSwitcher 组件
    - 调整布局以适应语言切换器
    - 确保桌面和移动端都正确显示
    - _需求：4.1, 4.4_
  
  - [ ] 7.2 更新导航链接使用 i18n 路由
    - 使用 next-intl 的 Link 组件
    - 确保所有链接包含语言前缀
    - _需求：2.2, 2.3_

- [ ] 8. 实现翻译工具函数
  - [ ] 8.1 创建 lib/i18n/utils.ts
    - 实现日期格式化函数
    - 实现数字格式化函数
    - 实现货币格式化函数
    - 实现翻译回退函数
    - _需求：9.1, 9.2, 9.3, 9.4, 11.1_
  
  - [ ] 8.2 编写属性测试：本地化格式化一致性
    - **属性 12：本地化格式化一致性**
    - **验证需求：9.1, 9.2, 9.3, 9.4**
  
  - [ ] 8.3 编写属性测试：翻译回退机制一致性
    - **属性 6：翻译回退机制一致性**
    - **验证需求：3.4, 7.4, 11.1, 11.3**

- [ ] 9. 翻译前台页面内容
  - [ ] 9.1 翻译首页内容
    - 创建 locales/[locale]/home.json
    - 翻译所有静态文本
    - 更新 page.tsx 使用翻译
    - _需求：3.1, 3.2_
  
  - [ ] 9.2 翻译关于页面
    - 创建 locales/[locale]/about.json
    - 翻译公司介绍、团队信息、发展历程
    - 更新 about/page.tsx
    - _需求：3.1, 3.2_
  
  - [ ] 9.3 翻译服务页面
    - 创建 locales/[locale]/services.json
    - 翻译服务项目和描述
    - 更新 services/page.tsx
    - _需求：3.1, 3.2_
  
  - [ ] 9.4 翻译其他页面（案例、联系、价格）
    - 创建相应的翻译文件
    - 更新页面组件
    - _需求：3.1, 3.2_
  
  - [ ] 9.5 编写属性测试：UI 组件翻译完整性
    - **属性 7：UI 组件翻译完整性**
    - **验证需求：3.5, 4.5**

- [ ] 10. 扩展数据库 schema 支持多语言
  - [ ] 10.1 创建数据库迁移脚本
    - 为 articles 表添加多语言字段
    - 为 categories 表添加多语言字段
    - 为 tags 表添加多语言字段
    - 添加索引和约束
    - _需求：7.2_
  
  - [ ] 10.2 运行数据库迁移
    - 在 Supabase 中执行迁移脚本
    - 验证表结构更新成功
    - _需求：7.2_
  
  - [ ] 10.3 更新 TypeScript 类型定义
    - 更新 types/database.ts
    - 添加多语言内容接口
    - _需求：7.2_

- [ ] 11. 实现动态内容的多语言支持
  - [ ] 11.1 创建内容查询辅助函数
    - 实现 getLocalizedContent 函数
    - 实现 getLocalizedField 函数
    - 处理翻译缺失的回退逻辑
    - _需求：3.3, 3.4, 7.3, 7.4_
  
  - [ ] 11.2 更新博客页面
    - 修改文章查询以支持多语言
    - 显示本地化的文章内容
    - 处理翻译缺失的情况
    - _需求：3.3, 3.4_
  
  - [ ] 11.3 更新案例页面
    - 修改案例查询以支持多语言
    - 显示本地化的案例内容
    - _需求：3.3, 3.4_

- [ ] 12. 检查点 - 前台功能完整性验证
  - 确保所有测试通过，验证前台所有页面的多语言功能正常，如有问题请询问用户

- [ ] 13. 开发后台多语言内容编辑器
  - [ ] 13.1 创建 MultilingualEditor 组件
    - 实现语言标签切换 UI
    - 为每种语言创建独立的输入字段
    - 显示翻译完整度指示器
    - _需求：6.1, 6.2, 6.5, 13.4_
  
  - [ ] 13.2 实现翻译完整度计算
    - 创建 calculateCompleteness 函数
    - 计算每种语言的完整度百分比
    - _需求：13.4_
  
  - [ ] 13.3 编写属性测试：翻译完整度计算准确性
    - **属性 11：翻译完整度计算准确性**
    - **验证需求：13.4**

- [ ] 14. 集成多语言编辑器到后台
  - [ ] 14.1 更新文章编辑页面
    - 集成 MultilingualEditor 组件
    - 为标题、摘要、内容添加多语言输入
    - 实现表单验证
    - _需求：6.1, 6.3, 13.1_
  
  - [ ] 14.2 更新分类和标签管理
    - 添加多语言名称和描述字段
    - 实现表单验证
    - _需求：6.2, 6.3_
  
  - [ ] 14.3 更新内容列表显示
    - 显示翻译完整度状态
    - 添加翻译状态筛选
    - _需求：6.4, 13.4_
  
  - [ ] 14.4 编写属性测试：多语言表单验证
    - **属性 10：多语言表单验证**
    - **验证需求：6.3, 13.1, 13.3**

- [ ] 15. 实现后台界面多语言
  - [ ] 15.1 创建后台翻译文件
    - 创建 locales/[locale]/admin.json
    - 翻译菜单、按钮、标签
    - 翻译表单验证消息
    - 翻译通知消息
    - _需求：12.1, 12.2, 12.4, 12.5_
  
  - [ ] 15.2 更新后台组件使用翻译
    - 更新 AdminSidebar 组件
    - 更新表单组件
    - 更新通知组件
    - _需求：12.2, 12.4, 12.5_
  
  - [ ] 15.3 添加后台语言切换器
    - 在后台添加独立的语言切换器
    - 确保界面语言和内容编辑语言独立
    - _需求：12.1, 12.3_
  
  - [ ] 15.4 编写属性测试：后台界面语言独立性
    - **属性 16：后台界面语言独立性**
    - **验证需求：12.2, 12.3, 12.4, 12.5**

- [ ] 16. 实现 SEO 优化功能
  - [ ] 16.1 生成 hreflang 标签
    - 在页面元数据中添加 hreflang 标签
    - 确保所有语言版本都被链接
    - _需求：5.1_
  
  - [ ] 16.2 生成多语言 sitemap
    - 创建 sitemap 生成函数
    - 为每种语言生成独立的 sitemap
    - _需求：5.2_
  
  - [ ] 16.3 添加 Open Graph 和 Twitter Card 元数据
    - 为每种语言生成本地化的社交媒体元数据
    - _需求：5.5_

- [ ] 17. 实现性能优化
  - [ ] 17.1 实现翻译文件按需加载
    - 配置 next-intl 的动态导入
    - 确保只加载当前语言的翻译
    - _需求：10.1, 10.2_
  
  - [ ] 17.2 实现翻译缓存
    - 配置浏览器缓存策略
    - 实现内存缓存
    - _需求：10.4_
  
  - [ ] 17.3 编写属性测试：资源加载优化
    - **属性 13：资源加载优化**
    - **验证需求：10.1, 10.2**
  
  - [ ] 17.4 编写属性测试：翻译缓存有效性
    - **属性 14：翻译缓存有效性**
    - **验证需求：10.4**
  
  - [ ] 17.5 编写属性测试：语言切换性能要求
    - **属性 18：语言切换性能要求**
    - **验证需求：14.5**

- [ ] 18. 实现错误处理和日志记录
  - [ ] 18.1 添加翻译缺失处理
    - 实现开发模式警告
    - 实现生产模式静默回退
    - _需求：11.1, 11.4_
  
  - [ ] 18.2 添加文件加载失败处理
    - 实现错误捕获和回退
    - 添加错误日志记录
    - _需求：11.2_
  
  - [ ] 18.3 添加数据库内容缺失处理
    - 实现内容回退逻辑
    - 添加语言标注显示
    - _需求：11.3_
  
  - [ ] 18.4 编写属性测试：错误处理和日志记录
    - **属性 15：错误处理和日志记录**
    - **验证需求：11.2, 11.4**

- [ ] 19. 创建翻译管理工具
  - [ ] 19.1 创建翻译覆盖率检查脚本
    - 扫描所有翻译文件
    - 识别缺失的翻译键
    - 生成覆盖率报告
    - _需求：11.5_
  
  - [ ] 19.2 创建批量翻译状态检查工具
    - 查询数据库中所有内容
    - 检查每个内容的翻译完整度
    - 生成状态报告
    - _需求：13.5_

- [ ] 20. 检查点 - 完整功能测试
  - 确保所有测试通过，进行完整的端到端测试，验证所有功能正常工作，如有问题请询问用户

- [ ] 21. 编写集成测试
  - [ ] 21.1 编写语言切换流程测试
    - 使用 Playwright 测试完整的语言切换流程
    - 验证 URL、内容、cookie 的更新
    - _需求：1.3, 2.3, 8.1_
  
  - [ ] 21.2 编写页面导航测试
    - 测试在不同语言下的页面导航
    - 验证内容正确加载
    - _需求：2.2, 3.1_
  
  - [ ] 21.3 编写后台内容管理测试
    - 测试多语言内容的创建和编辑
    - 验证表单验证和保存
    - _需求：6.1, 6.3, 13.1_

- [ ] 22. 更新文档和配置
  - [ ] 22.1 更新 README
    - 添加多语言功能说明
    - 添加翻译贡献指南
    - _需求：所有_
  
  - [ ] 22.2 创建翻译规范文档
    - 定义翻译键命名规范
    - 定义翻译质量标准
    - 提供翻译示例
    - _需求：7.1, 7.5_
  
  - [ ] 22.3 更新部署文档
    - 添加环境变量配置说明
    - 添加构建和部署步骤
    - _需求：所有_

- [ ] 23. 最终检查点 - 发布准备
  - 确保所有测试通过，验证文档完整，准备发布到生产环境，如有问题请询问用户

## 注意事项

- 每个检查点都应该确保之前的所有功能正常工作
- 属性测试应该配置为至少运行 100 次迭代
- 所有代码应该包含适当的 TypeScript 类型注解
- 翻译内容应该由专业人员审核，确保质量
- 性能测试应该在真实环境中进行
